<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common :: commonHead('收银台')}"></head>
<body>

<div>
    <nav th:replace="~{common :: sidebar('sale', 'sale_create')}"></nav>

    <main>
        <div th:replace="~{common :: topbar}"></div>

        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-4 border-bottom pb-3">
            <div>
                <h1 class="h4 mb-1">前台收银</h1>
                <span class="text-muted small">快速选择商品并结算</span>
            </div>
            <a href="/page/sale/list" class="btn btn-outline-secondary shadow-sm">
                <i class="bi bi-list-ul me-1"></i> 查看流水
            </a>
        </div>

        <div class="row g-4">
            <div class="col-md-8">
                <div class="card card-erp h-100">
                    <div class="card-header bg-white py-3">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-search"></i></span>
                            <input type="text" id="searchBox" class="form-control border-start-0 ps-0"
                                   placeholder="输入商品名称或拼音码检索..." onkeyup="filterProducts()">
                        </div>
                    </div>

                    <div class="card-body bg-light p-3" style="height: 600px; overflow-y: auto;">
                        <div class="row row-cols-3 row-cols-lg-4 g-3" id="productList">
                            <div class="col product-item" th:each="p : ${products}" th:data-name="${p.name}">
                                <div class="card h-100 shadow-sm border product-card cursor-pointer"
                                     th:onclick="addToCart([[${p.id}]], [[${p.name}]], [[${p.salePrice}]], [[${p.stock}]])">
                                    <div class="card-body p-3 d-flex flex-column justify-content-between">
                                        <div>
                                            <div class="fw-bold text-dark text-truncate" th:title="${p.name}" th:text="${p.name}"></div>
                                            <div class="text-muted small mt-1">库存: <span th:text="${p.stock}"></span></div>
                                        </div>
                                        <div class="mt-2 text-primary fw-bold">
                                            ¥<span th:text="${p.salePrice}"></span>
                                        </div>
                                    </div>
                                    <div th:if="${p.stock <= 0}" class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex align-items-center justify-content-center">
                                        <span class="badge bg-secondary">已售罄</span>
                                    </div>
                                </div>
                            </div>
                            <div id="noResultMsg" class="col-12 text-center py-5 text-muted d-none">
                                <p>未找到相关商品</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-erp h-100 d-flex flex-column">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 fw-bold">购物清单</h6>
                        <button class="btn btn-sm btn-link text-muted text-decoration-none p-0" onclick="clearCart()">清空</button>
                    </div>

                    <div class="card-body p-0 flex-grow-1" style="height: 400px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-muted sticky-top">
                            <tr>
                                <th class="ps-3">商品</th>
                                <th style="width: 100px;" class="text-center">数量</th>
                                <th class="text-end pe-3">小计</th>
                                <th style="width: 30px;"></th>
                            </tr>
                            </thead>
                            <tbody id="cartTableBody">
                            </tbody>
                        </table>

                        <div id="emptyCartMsg" class="text-center text-muted py-5 mt-4">
                            <i class="bi bi-cart3 fs-1 text-gray-300"></i>
                            <p class="mt-2 small">请从左侧添加商品</p>
                        </div>
                    </div>

                    <div class="card-footer bg-white p-3 border-top">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">总数量</span>
                            <span class="fw-bold" id="itemCount">0</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="h5 mb-0">应收总额</span>
                            <span class="h4 mb-0 fw-bold text-primary" id="totalAmount">¥0.00</span>
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-primary py-2" onclick="submitSale()">确认收款</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div th:replace="~{common :: commonScripts}"></div>

<style>
    .product-card:hover {
        border-color: #0d6efd !important; /* 鼠标悬停变蓝边框，简单直接 */
        cursor: pointer;
    }
    /* 去掉数字输入框的默认样式 */
    .qty-input {
        text-align: center;
        border: 1px solid #dee2e6;
    }
    .qty-input:focus {
        border-color: #86b7fe;
        outline: 0;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
</style>

<script>
    let cart = [];

    // 1. 添加商品
    function addToCart(id, name, price, stock) {
        if (stock <= 0) { alert("该商品已售罄"); return; }

        let existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            if (existingItem.qty >= stock) { alert("库存不足"); return; }
            existingItem.qty++;
        } else {
            cart.push({ id: id, name: name, price: price, qty: 1, stock: stock });
        }
        renderCart();
    }

    // 2. 渲染购物车 (表格结构与 sale_list 保持一致)
    function renderCart() {
        let tbody = $("#cartTableBody");
        tbody.empty();
        let total = 0;
        let count = 0;

        if (cart.length === 0) {
            $("#emptyCartMsg").show();
        } else {
            $("#emptyCartMsg").hide();
            cart.forEach((item, index) => {
                let subtotal = item.price * item.qty;
                total += subtotal;
                count += parseInt(item.qty);

                let row = `
                    <tr>
                        <td class="ps-3">
                            <div class="text-dark fw-bold text-truncate" style="max-width: 100px;" title="${item.name}">${item.name}</div>
                        </td>
                        <td>
                            <div class="input-group input-group-sm">
                                <button class="btn btn-outline-secondary" onclick="changeQty(${index}, -1)">-</button>
                                <input type="number" class="form-control qty-input px-0"
                                       value="${item.qty}" onchange="manualInputQty(${index}, this.value)">
                                <button class="btn btn-outline-secondary" onclick="changeQty(${index}, 1)">+</button>
                            </div>
                        </td>
                        <td class="text-end pe-3 fw-bold text-primary">¥${subtotal.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-link text-muted p-0" onclick="removeFromCart(${index})">
                                <i class="bi bi-x-lg small"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        $("#totalAmount").text("¥" + total.toFixed(2));
        $("#itemCount").text(count);
    }

    // 3. 数量逻辑
    function changeQty(index, delta) {
        validateAndSetQty(index, cart[index].qty + delta);
    }
    function manualInputQty(index, value) {
        let newQty = parseInt(value);
        if (isNaN(newQty)) newQty = 1;
        validateAndSetQty(index, newQty);
    }
    function validateAndSetQty(index, newQty) {
        let item = cart[index];
        if (newQty <= 0) {
            if(confirm("移除该商品？")) { removeFromCart(index); return; } else { newQty = 1; }
        }
        if (newQty > item.stock) {
            alert("库存不足，最多 " + item.stock); newQty = item.stock;
        }
        item.qty = newQty;
        renderCart();
    }
    function removeFromCart(index) {
        cart.splice(index, 1); renderCart();
    }
    function clearCart() {
        if(cart.length === 0) return;
        if(!confirm("确定清空清单？")) return;
        cart = []; renderCart();
    }

    // 4. 搜索逻辑
    function filterProducts() {
        let text = $("#searchBox").val().toLowerCase();
        let hasResult = false;
        $(".product-item").each(function() {
            let name = $(this).data("name").toString().toLowerCase();
            if (name.includes(text)) { $(this).removeClass("d-none"); hasResult = true; } else { $(this).addClass("d-none"); }
        });
        hasResult ? $("#noResultMsg").addClass("d-none") : $("#noResultMsg").removeClass("d-none");
    }

    // 5. 提交
    function submitSale() {
        if (cart.length === 0) { alert("清单为空"); return; }
        if (!confirm("确认收款 " + $("#totalAmount").text() + " ?")) return;

        // 简单的 Ajax 提交逻辑
        let requests = cart.map(item => {
            return $.ajax({
                url: "/sale/add", type: "POST", contentType: "application/json",
                data: JSON.stringify({ productId: item.id, quantity: item.qty, salePrice: item.price })
            });
        });

        Promise.all(requests).then(() => {
            alert("收款成功！");
            cart = [];
            renderCart();
            location.reload();
        }).catch(() => {
            alert("结算出错，请检查库存");
            location.reload();
        });
    }
</script>

</body>
</html>