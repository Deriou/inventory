<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common :: commonHead('收银台')}"></head>
<body>

<div>
    <nav th:replace="~{common :: sidebar('sale', 'sale_create')}"></nav>

    <main class="bg-light">
        <div th:replace="~{common :: topbar}"></div>

        <div class="container-fluid p-0">
            <div class="row g-4 m-0" style="height: calc(100vh - 100px);">

                <div class="col-md-8 d-flex flex-column h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3 pt-2 px-1">
                        <div>
                            <h1 class="h4 mb-0 fw-bold text-gray-800"><i class="bi bi-shop me-2"></i>前台收银</h1>
                            <span class="text-muted small">点击商品卡片加入清单</span>
                        </div>
                        <div class="input-group" style="width: 300px;">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                            <input type="text" id="searchBox" class="form-control border-start-0 ps-0"
                                   placeholder="搜索商品名称/拼音..." onkeyup="filterProducts()">
                        </div>
                    </div>

                    <div class="flex-grow-1 overflow-auto p-1">
                        <div class="row row-cols-3 row-cols-lg-4 g-3" id="productList">
                            <div class="col product-item" th:each="p : ${products}" th:data-name="${p.name}">
                                <div class="card h-100 border-0 shadow-sm product-card cursor-pointer position-relative"
                                     th:onclick="addToCart([[${p.id}]], [[${p.name}]], [[${p.salePrice}]], [[${p.stock}]])"
                                     style="transition: all 0.2s; cursor: pointer;">
                                    <div class="card-body p-3 d-flex flex-column justify-content-between">
                                        <div>
                                            <h6 class="fw-bold text-dark mb-1 text-truncate" th:title="${p.name}" th:text="${p.name}">商品名称</h6>
                                            <span class="badge bg-light text-secondary border fw-normal mb-2">库存: <span th:text="${p.stock}"></span></span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-end mt-2">
                                            <span class="h5 mb-0 text-primary fw-bold">¥<span th:text="${p.salePrice}"></span></span>
                                            <i class="bi bi-plus-circle-fill text-primary fs-5 opacity-50 hover-icon"></i>
                                        </div>
                                    </div>
                                    <div th:if="${p.stock <= 0}" class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex align-items-center justify-content-center rounded">
                                        <span class="badge bg-secondary">已售罄</span>
                                    </div>
                                </div>
                            </div>

                            <div id="noResultMsg" class="col-12 text-center py-5 text-muted d-none">
                                <i class="bi bi-search fs-1"></i>
                                <p class="mt-2">未找到相关商品</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 h-100">
                    <div class="card card-erp h-100 border-0 shadow-lg d-flex flex-column">
                        <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
                            <h5 class="m-0"><i class="bi bi-receipt me-2"></i>购物清单</h5>
                            <button class="btn btn-sm btn-outline-light border-0" onclick="clearCart()" title="清空">
                                <i class="bi bi-trash"></i> 清空
                            </button>
                        </div>

                        <div class="card-body p-0 flex-grow-1 overflow-auto bg-light">
                            <table class="table table-hover align-middle mb-0 bg-white">
                                <thead class="bg-light sticky-top text-muted small">
                                <tr>
                                    <th class="ps-3">商品</th>
                                    <th style="width: 90px;">数量</th>
                                    <th class="text-end pe-3">金额</th>
                                    <th style="width: 40px;"></th>
                                </tr>
                                </thead>
                                <tbody id="cartTableBody">
                                </tbody>
                            </table>

                            <div id="emptyCartMsg" class="text-center text-muted py-5 mt-4">
                                <div class="mb-3">
                                    <i class="bi bi-cart4 display-1 text-gray-300"></i>
                                </div>
                                <p>请在左侧点击商品加入</p>
                            </div>
                        </div>

                        <div class="card-footer bg-white p-4 border-top">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">商品数量</span>
                                <span class="fw-bold" id="itemCount">0 件</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-end mb-4">
                                <span class="h5 mb-0">应收总额</span>
                                <span class="display-6 fw-bold text-danger" id="totalAmount">¥0.00</span>
                            </div>
                            <button class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm" onclick="submitSale()">
                                <i class="bi bi-check2-circle me-2"></i> 确认收款
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div th:replace="~{common :: commonScripts}"></div>

<style>
    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.1) !important;
    }
    .hover-icon {
        transition: opacity 0.2s;
    }
    .product-card:hover .hover-icon {
        opacity: 1 !important;
    }
</style>

<script>
    // 购物车数据
    let cart = [];

    // 1. 添加商品
    function addToCart(id, name, price, stock) {
        if (stock <= 0) {
            // 简单的震动反馈或提示
            alert("手慢了，该商品已售罄！");
            return;
        }

        let existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            if (existingItem.qty >= stock) {
                alert("已达到库存上限 (" + stock + ")");
                return;
            }
            existingItem.qty++;
        } else {
            cart.push({ id: id, name: name, price: price, qty: 1, stock: stock });
        }
        renderCart();
    }

    // 2. 渲染购物车
    function renderCart() {
        let tbody = $("#cartTableBody");
        tbody.empty();
        let total = 0;
        let count = 0;

        if (cart.length === 0) {
            $("#emptyCartMsg").show();
        } else {
            $("#emptyCartMsg").hide();
            cart.forEach((item, index) => {
                let subtotal = item.price * item.qty;
                total += subtotal;
                count += item.qty;

                let row = `
                    <tr>
                        <td class="ps-3">
                            <div class="fw-bold text-truncate" style="max-width: 120px;" title="${item.name}">${item.name}</div>
                            <div class="small text-muted">¥${item.price}</div>
                        </td>
                        <td>
                            <div class="input-group input-group-sm">
                                <button class="btn btn-outline-secondary px-1" onclick="updateQty(${index}, ${item.qty - 1})">-</button>
                                <input type="text" class="form-control text-center px-0" value="${item.qty}" readonly>
                                <button class="btn btn-outline-secondary px-1" onclick="updateQty(${index}, ${item.qty + 1})">+</button>
                            </div>
                        </td>
                        <td class="text-end pe-3 fw-bold text-dark">¥${subtotal.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-link text-danger p-0" onclick="removeFromCart(${index})">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        // 更新底部数据
        $("#totalAmount").text("¥" + total.toFixed(2));
        $("#itemCount").text(count + " 件");
    }

    // 3. 更新数量 (支持加减按钮)
    function updateQty(index, newQty) {
        if (newQty <= 0) {
            removeFromCart(index);
            return;
        }
        if (newQty > cart[index].stock) {
            alert("库存不足，当前只有 " + cart[index].stock + " 件");
            return;
        }
        cart[index].qty = newQty;
        renderCart();
    }

    // 4. 移除商品
    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // 5. 清空
    function clearCart() {
        if(cart.length === 0) return;
        if(!confirm("确定清空当前清单吗？")) return;
        cart = [];
        renderCart();
    }

    // 6. 搜索过滤
    function filterProducts() {
        let text = $("#searchBox").val().toLowerCase();
        let hasResult = false;

        $(".product-item").each(function() {
            let name = $(this).data("name").toString().toLowerCase();
            if (name.includes(text)) {
                $(this).removeClass("d-none");
                hasResult = true;
            } else {
                $(this).addClass("d-none");
            }
        });

        // 显示/隐藏无结果提示
        if(hasResult) {
            $("#noResultMsg").addClass("d-none");
        } else {
            $("#noResultMsg").removeClass("d-none");
        }
    }

    // 7. 提交结算
    function submitSale() {
        if (cart.length === 0) {
            alert("请先添加商品！");
            return;
        }

        let totalStr = $("#totalAmount").text();
        if (!confirm("共 " + $("#itemCount").text() + "，合计 " + totalStr + "\n确认收款吗？")) {
            return;
        }

        // 模拟批量提交 (后端接口是一条条插的)
        let successCount = 0;
        // 使用 Promise.all 等待所有请求
        let requests = cart.map(item => {
            return $.ajax({
                url: "/sale/add",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    productId: item.id,
                    quantity: item.qty,
                    salePrice: item.price
                })
            }).then(res => {
                if(res.success) successCount++;
                return res;
            });
        });

        Promise.all(requests).then(() => {
            alert("结算成功！");
            cart = [];
            renderCart();
            location.reload();
        }).catch(() => {
            alert("部分商品结算可能失败，请检查网络或库存。");
            location.reload();
        });
    }
</script>

</body>
</html>