<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common :: commonHead('æ”¶é“¶å°')}"></head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav th:replace="~{common :: sidebar('sale')}"></nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div th:replace="~{common :: topbar}"></div>

            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                <h1 class="h4">ğŸ’° æ”¶é“¶å°</h1>
            </div>

            <div class="row">
                <div class="col-md-7">
                    <div class="card card-erp h-100">
                        <div class="card-header bg-white">é€‰æ‹©å•†å“</div>
                        <div class="card-body">
                            <input type="text" class="form-control mb-3" placeholder="è¾“å…¥å•†å“åæˆ–æ¡ç æœç´¢...">

                            <div class="list-group">
                                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                        th:each="p : ${products}"
                                        th:onclick="addToCart([[${p.id}]], [[${p.name}]], [[${p.salePrice}]], [[${p.stock}]])">
                                    <div>
                                        <div class="fw-bold" th:text="${p.name}"></div>
                                        <small class="text-muted" th:text="'åº“å­˜: ' + ${p.stock}"></small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill" th:text="'Â¥' + ${p.salePrice}"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="card card-erp border-primary h-100">
                        <div class="card-header bg-primary text-white">ç»“ç®—æ¸…å•</div>
                        <div class="card-body d-flex flex-column">
                            <div class="flex-grow-1" id="cartItems" style="min-height: 200px;">
                                <p class="text-muted text-center mt-5">è¯·ä»å·¦ä¾§é€‰æ‹©å•†å“</p>
                            </div>

                            <hr>
                            <div class="d-flex justify-content-between fs-4 fw-bold">
                                <span>æ€»è®¡ï¼š</span>
                                <span class="text-danger" id="totalAmount">Â¥0.00</span>
                            </div>

                            <button class="btn btn-success btn-lg mt-3 w-100" onclick="submitSale()">
                                <i class="bi bi-check-circle"></i> ç¡®è®¤æ”¶æ¬¾
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
    // ç®€å•çš„è´­ç‰©è½¦é€»è¾‘ (ä¸ºäº†è¯¾è®¾æ¼”ç¤ºï¼Œæˆ‘ä»¬ç®€åŒ–ä¸º"åªèƒ½ä¹°ä¸€ç§å•†å“"ï¼Œæˆ–è€…ä½ å¯ä»¥æ‰©å±•ä¸ºæ•°ç»„)
    // è¿™é‡Œä¸ºäº†å¯¹æ¥æˆ‘ä»¬åç«¯çš„ Sale æ¥å£ (å•æ¬¡åªèƒ½ä¹°ä¸€ç§)ï¼Œæˆ‘ä»¬åšæˆ"å•å“ç»“ç®—"æ¨¡å¼

    let currentItem = null;

    function addToCart(id, name, price, stock) {
        if (stock <= 0) {
            alert("è¯¥å•†å“åº“å­˜ä¸è¶³ï¼");
            return;
        }

        // æ›´æ–°å½“å‰é€‰ä¸­çš„å•†å“
        currentItem = { id: id, price: price };

        // æ¸²æŸ“å³ä¾§ç•Œé¢
        let html = `
            <div class="alert alert-light border">
                <h5>${name}</h5>
                <div class="input-group mt-2">
                    <span class="input-group-text">æ•°é‡</span>
                    <input type="number" class="form-control" id="qtyInput" value="1" min="1" max="${stock}" onchange="updateTotal()">
                </div>
                <div class="text-end mt-2 text-muted">å•ä»·: Â¥${price}</div>
            </div>
        `;
        $("#cartItems").html(html);
        updateTotal();
    }

    function updateTotal() {
        if (!currentItem) return;
        let qty = $("#qtyInput").val();
        let total = (currentItem.price * qty).toFixed(2);
        $("#totalAmount").text("Â¥" + total);
    }

    function submitSale() {
        if (!currentItem) {
            alert("è¯·å…ˆé€‰æ‹©å•†å“");
            return;
        }

        let qty = $("#qtyInput").val();

        // æ„å»ºåç«¯ Sale å¯¹è±¡
        let saleData = {
            productId: currentItem.id,
            quantity: qty,
            salePrice: currentItem.price
        };

        $.ajax({
            url: "/sale/add",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(saleData),
            success: function(res) {
                if (res.success) {
                    alert("æ”¶æ¬¾æˆåŠŸï¼åˆ©æ¶¦å·²å…¥è´¦ã€‚");
                    location.reload();
                } else {
                    alert(res.msg);
                }
            }
        });
    }
</script>
</body>
</html>