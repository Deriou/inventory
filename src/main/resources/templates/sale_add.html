<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common :: commonHead('æ”¶é“¶å°')}"></head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav th:replace="~{common :: sidebar('sale')}"></nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div th:replace="~{common :: topbar}"></div>

            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                <h1 class="h4">ğŸ›’ æ”¶é“¶å°</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <a href="/page/sale" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-clock-history"></i> æŸ¥çœ‹é”€å”®å†å²
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-md-7">
                    <div class="card card-erp h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span>å•†å“åˆ—è¡¨</span>
                            <span class="badge bg-secondary" th:text="${#lists.size(products)} + ' ç§å•†å“'"></span>
                        </div>
                        <div class="card-body">
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchInput" placeholder="è¾“å…¥å•†å“åç§°æˆ–æ¡ç æœç´¢..." onkeyup="filterProducts()">
                            </div>

                            <div class="list-group overflow-auto" style="max-height: 600px;" id="productList">
                                <button type="button" class="list-group-item list-group-item-action product-item"
                                        th:each="p : ${products}"
                                        th:data-name="${p.name}"
                                        th:onclick="addToCart([[${p.id}]], [[${p.name}]], [[${p.salePrice}]], [[${p.stock}]])">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1 fw-bold" th:text="${p.name}"></h6>
                                            <small th:if="${p.stock > p.warningNum}" class="text-success">
                                                <i class="bi bi-check-circle-fill"></i> åº“å­˜å……è¶³: [[${p.stock}]]
                                            </small>
                                            <small th:if="${p.stock <= p.warningNum && p.stock > 0}" class="text-warning">
                                                <i class="bi bi-exclamation-circle-fill"></i> åº“å­˜ç´§å¼ : [[${p.stock}]]
                                            </small>
                                            <small th:if="${p.stock <= 0}" class="text-danger">
                                                <i class="bi bi-x-circle-fill"></i> å·²å”®ç½„
                                            </small>
                                        </div>
                                        <span class="badge bg-primary rounded-pill fs-6" th:text="'Â¥' + ${p.salePrice}"></span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="card card-erp border-primary h-100 shadow-sm">
                        <div class="card-header bg-primary text-white d-flex justify-content-between">
                            <span><i class="bi bi-cart4"></i> ç»“ç®—æ¸…å•</span>
                            <span id="cartCountBadge" class="badge bg-white text-primary">0</span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="flex-grow-1 overflow-auto" id="cartItems" style="height: 400px; max-height: 400px;">
                                <div class="text-center text-muted mt-5 pt-5" id="emptyCartMsg">
                                    <i class="bi bi-basket2" style="font-size: 3rem; color: #dee2e6;"></i>
                                    <p class="mt-3">è¯·ç‚¹å‡»å·¦ä¾§å•†å“åŠ å…¥æ¸…å•</p>
                                </div>
                            </div>

                            <div class="border-top pt-3 mt-3 bg-white">
                                <div class="d-flex justify-content-between align-items-end mb-3">
                                    <span class="text-muted">æ€»é‡‘é¢ï¼š</span>
                                    <span class="display-6 fw-bold text-danger" id="totalAmount">Â¥0.00</span>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-lg" onclick="submitSale()" id="payBtn" disabled>
                                        <i class="bi bi-check2-circle"></i> ç¡®è®¤æ”¶æ¬¾ (ç»“ç®—)
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="clearCart()">
                                        æ¸…ç©ºæ¸…å•
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
    // --- æ ¸å¿ƒé€»è¾‘ ---

    // è´­ç‰©è½¦æ•°ç»„
    let cart = [];

    // 1. æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
    function addToCart(id, name, price, stock) {
        if (stock <= 0) {
            alert("âŒ è¯¥å•†å“å·²å”®ç½„ï¼Œæ— æ³•æ·»åŠ ï¼");
            return;
        }

        // æ£€æŸ¥è´­ç‰©è½¦é‡Œæ˜¯å¦å·²ç»æœ‰äº†
        let existingItem = cart.find(item => item.id === id);

        if (existingItem) {
            if (existingItem.qty >= stock) {
                alert("âš ï¸ åº“å­˜ä¸è¶³ï¼Œæ— æ³•ç»§ç»­æ·»åŠ ï¼");
                return;
            }
            existingItem.qty++;
        } else {
            cart.push({
                id: id,
                name: name,
                price: parseFloat(price),
                stock: stock,
                qty: 1
            });
        }
        renderCart();
    }

    // 2. æ¸²æŸ“è´­ç‰©è½¦ç•Œé¢
    function renderCart() {
        let container = $("#cartItems");
        let emptyMsg = $("#emptyCartMsg");
        let payBtn = $("#payBtn");
        let badge = $("#cartCountBadge");

        if (cart.length === 0) {
            container.html("");
            container.append(emptyMsg);
            emptyMsg.show();
            payBtn.prop("disabled", true);
            badge.text(0);
            $("#totalAmount").text("Â¥0.00");
            return;
        }

        emptyMsg.hide();
        payBtn.prop("disabled", false);
        container.html("");

        let total = 0;
        let count = 0;

        cart.forEach((item, index) => {
            let itemTotal = item.price * item.qty;
            total += itemTotal;
            count += item.qty;

            let html = `
                <div class="card mb-2 border-0 shadow-sm bg-light">
                    <div class="card-body p-2 d-flex justify-content-between align-items-center">
                        <div style="width: 40%">
                            <div class="fw-bold text-truncate" title="${item.name}">${item.name}</div>
                            <small class="text-muted">Â¥${item.price} x ${item.qty}</small>
                        </div>
                        <div class="fw-bold text-primary">Â¥${itemTotal.toFixed(2)}</div>
                        <div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="updateQty(${index}, -1)">-</button>
                                <button class="btn btn-outline-secondary" disabled>${item.qty}</button>
                                <button class="btn btn-outline-secondary" onclick="updateQty(${index}, 1)">+</button>
                            </div>
                            <button class="btn btn-sm text-danger ms-1" onclick="removeItem(${index})">&times;</button>
                        </div>
                    </div>
                </div>
            `;
            container.append(html);
        });

        $("#totalAmount").text("Â¥" + total.toFixed(2));
        badge.text(count);
    }

    // 3. æ›´æ–°æ•°é‡
    function updateQty(index, change) {
        let item = cart[index];
        let newQty = item.qty + change;

        if (newQty > item.stock) {
            alert("åº“å­˜ä¸Šé™ï¼");
            return;
        }
        if (newQty <= 0) {
            removeItem(index);
            return;
        }
        item.qty = newQty;
        renderCart();
    }

    // 4. ç§»é™¤å•†å“
    function removeItem(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // 5. æ¸…ç©º
    function clearCart() {
        if(confirm("ç¡®å®šæ¸…ç©ºå½“å‰æ¸…å•å—ï¼Ÿ")) {
            cart = [];
            renderCart();
        }
    }

    // 6. æœç´¢è¿‡æ»¤
    function filterProducts() {
        let keyword = $("#searchInput").val().toLowerCase();
        $(".product-item").each(function() {
            let name = $(this).data("name").toString().toLowerCase();
            if (name.includes(keyword)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }

    // 7. æäº¤ç»“ç®— (æ ¸å¿ƒï¼šæ‰¹é‡è°ƒç”¨åç«¯æ¥å£)
    function submitSale() {
        if (cart.length === 0) return;
        if (!confirm("ç¡®è®¤ç»“ç®—æ”¶æ¬¾ " + $("#totalAmount").text() + " å—ï¼Ÿ")) return;

        let payBtn = $("#payBtn");
        payBtn.prop("disabled", true).text("æ­£åœ¨ç»“ç®—...");

        // å› ä¸ºåç«¯åªæ”¯æŒæ¥æ”¶å•ä¸ª Sale å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¾ªç¯å‘é€è¯·æ±‚
        // ä½¿ç”¨ Promise.all ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
        let requests = cart.map(item => {
            let saleData = {
                productId: item.id,
                quantity: item.qty,
                salePrice: item.price
            };
            return $.ajax({
                url: "/sale/add",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(saleData)
            });
        });

        Promise.all(requests)
            .then(responses => {
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸ (æ ¹æ®åç«¯é€»è¾‘ï¼Œåªè¦æ²¡æŠ›å¼‚å¸¸å°±ç®—HTTP 200ï¼Œä½†æˆ‘ä»¬è¦çœ‹ success å­—æ®µ)
                let allSuccess = responses.every(res => res.success === true);
                if (allSuccess) {
                    alert("âœ… ç»“ç®—æˆåŠŸï¼æ‰€æœ‰å•†å“å·²å‡ºåº“ã€‚");
                    location.reload(); // åˆ·æ–°é¡µé¢æ›´æ–°åº“å­˜
                } else {
                    alert("âš ï¸ éƒ¨åˆ†å•†å“ç»“ç®—å¯èƒ½å¤±è´¥ï¼Œè¯·æŸ¥çœ‹é”€å”®è®°å½•ã€‚");
                    location.reload();
                }
            })
            .catch(err => {
                alert("âŒ ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œç»“ç®—å¤±è´¥ï¼");
                console.error(err);
                payBtn.prop("disabled", false).text("ç¡®è®¤æ”¶æ¬¾ (ç»“ç®—)");
            });
    }
</script>

</body>
</html>