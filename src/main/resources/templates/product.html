<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common :: commonHead('å•†å“åˆ—è¡¨')}"></head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav th:replace="~{common :: sidebar('product')}"></nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">

            <div th:replace="~{common :: topbar}"></div>

            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                <h1 class="h4">å•†å“ç®¡ç†</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
                        <i class="bi bi-plus-lg"></i> æ–°å¢å•†å“
                    </button>
                </div>
            </div>

            <div class="card card-erp">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>å•†å“åç§°</th>
                                <th>ä¾›åº”å•†</th>
                                <th>æˆæœ¬ä»·</th>
                                <th>é›¶å”®ä»·</th>
                                <th>å½“å‰åº“å­˜</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="p : ${products}">
                                <td th:text="${p.id}"></td>
                                <td class="fw-bold" th:text="${p.name}"></td>
                                <td class="text-muted small" th:text="${p.supplier}"></td>
                                <td th:text="${p.costPrice}"></td>
                                <td class="text-success fw-bold" th:text="${p.salePrice}"></td>

                                <td>
                                    <span th:text="${p.stock}" class="fs-6"></span>
                                </td>

                                <td>
                                        <span th:if="${p.stock < p.warningNum}" class="badge bg-danger">
                                            <i class="bi bi-exclamation-circle"></i> åº“å­˜ç´§å¼ 
                                        </span>
                                    <span th:if="${p.stock >= p.warningNum}" class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> å……è¶³
                                        </span>
                                </td>

                                <td>
                                    <button class="btn btn-sm btn-light text-primary"
                                            th:onclick="openEditModal([[${p.id}]], [[${p.name}]], [[${p.costPrice}]], [[${p.salePrice}]], [[${p.stock}]], [[${p.warningNum}]], [[${p.supplier}]])">
                                        ç¼–è¾‘
                                    </button>

                                    <button class="btn btn-sm btn-light text-danger"
                                            th:onclick="deleteProduct([[${p.id}]])">
                                        ä¸‹æ¶
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–°å¢å•†å“æ¡£æ¡ˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="mb-3">
                        <label class="form-label">å•†å“åç§°</label>
                        <input type="text" class="form-control" name="name" placeholder="ä¾‹å¦‚ï¼šå¯å£å¯ä¹ 330ml" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">è¿›è´§æˆæœ¬ (å…ƒ)</label>
                            <input type="number" class="form-control" name="costPrice" step="0.01">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">é›¶å”®ä»·æ ¼ (å…ƒ)</label>
                            <input type="number" class="form-control" name="salePrice" step="0.01">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">åˆå§‹åº“å­˜</label>
                            <input type="number" class="form-control" name="stock" value="0">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">é¢„è­¦é˜ˆå€¼</label>
                            <input type="number" class="form-control" name="warningNum" value="10" help="ä½äºæ­¤æ•°é‡å°†æŠ¥è­¦">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä¾›åº”å•†</label>
                        <input type="text" class="form-control" name="supplier">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">ä¿å­˜æ¡£æ¡ˆ</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç¼–è¾‘å•†å“ä¿¡æ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" name="id" id="edit_id">

                    <div class="mb-3">
                        <label class="form-label">å•†å“åç§°</label>
                        <input type="text" class="form-control" name="name" id="edit_name" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">è¿›è´§æˆæœ¬</label>
                            <input type="number" class="form-control" name="costPrice" id="edit_costPrice" step="0.01">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">é›¶å”®ä»·æ ¼</label>
                            <input type="number" class="form-control" name="salePrice" id="edit_salePrice" step="0.01">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">å½“å‰åº“å­˜</label>
                            <input type="number" class="form-control" name="stock" id="edit_stock">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">é¢„è­¦é˜ˆå€¼</label>
                            <input type="number" class="form-control" name="warningNum" id="edit_warningNum">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä¾›åº”å•†</label>
                        <input type="text" class="form-control" name="supplier" id="edit_supplier">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitUpdate()">ç¡®è®¤ä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    // 1. æ–°å¢å•†å“ (ä½ åŸæœ‰çš„ä»£ç ï¼Œä¿æŒä¸å˜)
    function saveProduct() {
        var formData = {};
        $("#addForm").serializeArray().forEach(item => formData[item.name] = item.value);
        $.ajax({
            url: "/product/add",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(formData),
            success: function(res) {
                if (res.success) { location.reload(); } else { alert("ä¿å­˜å¤±è´¥"); }
            }
        });
    }

    // === ğŸ‘‡ æ–°å¢ä»¥ä¸‹ä»£ç  ğŸ‘‡ ===

    // 2. æ‰“å¼€ç¼–è¾‘å¼¹çª—ï¼ˆæŠŠè¡¨æ ¼é‡Œçš„æ•°æ®å¡«å…¥è¾“å…¥æ¡†ï¼‰
    function openEditModal(id, name, cost, sale, stock, warning, supplier) {
        // ç»™è¡¨å•èµ‹å€¼
        $("#edit_id").val(id);
        $("#edit_name").val(name);
        $("#edit_costPrice").val(cost);
        $("#edit_salePrice").val(sale);
        $("#edit_stock").val(stock);
        $("#edit_warningNum").val(warning);
        $("#edit_supplier").val(supplier);

        // æ˜¾ç¤ºå¼¹çª—
        $("#editModal").modal("show");
    }

    // 3. æäº¤ä¿®æ”¹
    function submitUpdate() {
        var formData = {};
        $("#editForm").serializeArray().forEach(item => formData[item.name] = item.value);

        $.ajax({
            url: "/product/update", // è°ƒç”¨åˆšæ‰å†™çš„åç«¯æ¥å£
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(formData),
            success: function(res) {
                if (res.success) {
                    alert("ä¿®æ”¹æˆåŠŸï¼");
                    location.reload();
                } else {
                    alert("ä¿®æ”¹å¤±è´¥ï¼š" + res.msg);
                }
            }
        });
    }

    // 4. ä¸‹æ¶ï¼ˆåˆ é™¤ï¼‰å•†å“
    function deleteProduct(id) {
        if (!confirm("ç¡®å®šè¦ä¸‹æ¶ï¼ˆåˆ é™¤ï¼‰è¯¥å•†å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) {
            return;
        }
        $.ajax({
            url: "/product/delete/" + id,
            type: "POST",
            success: function(res) {
                if (res.success) {
                    alert("å·²ä¸‹æ¶ï¼");
                    location.reload();
                } else {
                    alert("æ“ä½œå¤±è´¥ï¼š" + res.msg);
                }
            }
        });
    }
</script>
</body>
</html>