<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common :: commonHead('è´¢åŠ¡æŠ¥è¡¨')}"></head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav th:replace="~{common :: sidebar('finance')}"></nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div th:replace="~{common :: topbar}"></div>

            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">ğŸ“Š è´¢åŠ¡ç®¡ç†ä¸­å¿ƒ</h1>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card card-erp bg-success text-white h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-wallet2"></i> æ€»é”€å”®æ”¶å…¥</h5>
                            <p class="display-6 fw-bold" id="totalRevenue">Â¥0.00</p>
                            <small>å†å²ç´¯è®¡é”€å”®æ€»é¢</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-erp bg-warning text-dark h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-cart-x"></i> æ€»é‡‡è´­æ”¯å‡º</h5>
                            <p class="display-6 fw-bold" id="totalCost">Â¥0.00</p>
                            <small>å†å²ç´¯è®¡è¿›è´§æˆæœ¬</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-erp bg-primary text-white h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-piggy-bank"></i> æ€»æ¯›åˆ©æ¶¦</h5>
                            <p class="display-6 fw-bold" id="totalProfit">Â¥0.00</p>
                            <small>é”€å”®é¢ - å•†å“æˆæœ¬</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card card-erp">
                <div class="card-header bg-white fw-bold">
                    ğŸ“‰ è¿‘7å¤© æ”¶æ”¯èµ°åŠ¿å¯¹æ¯”
                </div>
                <div class="card-body">
                    <div id="financeChart" style="width: 100%; height: 450px;"></div>
                </div>
            </div>

        </main>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.2/echarts.min.js"></script>

<script>
    $(document).ready(function() {
        $.ajax({
            url: "/finance/data",
            type: "GET",
            success: function(res) {
                // 1. å¡«å……å¡ç‰‡æ•°å­—
                $("#totalRevenue").text("Â¥" + res.totalRevenue.toFixed(2));
                $("#totalCost").text("Â¥" + res.totalCost.toFixed(2));
                $("#totalProfit").text("Â¥" + res.totalProfit.toFixed(2));

                // 2. æ¸²æŸ“å›¾è¡¨
                initFinanceChart(res);
            }
        });
    });

    function initFinanceChart(data) {
        var myChart = echarts.init(document.getElementById('financeChart'));
        var option = {
            tooltip: { trigger: 'axis' },
            legend: { data: ['æ”¶å…¥ (Sales)', 'æ”¯å‡º (Inbound)'] },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: data.dates
            },
            yAxis: { type: 'value' },
            series: [
                {
                    name: 'æ”¶å…¥ (Sales)',
                    type: 'line',
                    data: data.incomes,
                    smooth: true,
                    itemStyle: { color: '#198754' }, // ç»¿è‰²
                    areaStyle: { opacity: 0.1 }
                },
                {
                    name: 'æ”¯å‡º (Inbound)',
                    type: 'line',
                    data: data.expenses,
                    smooth: true,
                    itemStyle: { color: '#ffc107' }, // é»„è‰²
                    lineStyle: { type: 'dashed' }
                }
            ]
        };
        myChart.setOption(option);
        window.onresize = function() { myChart.resize(); };
    }
</script>
</body>
</html>